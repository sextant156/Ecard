var __awaiter=this&&this.__awaiter||function(e,t,a,n){function i(e){return e instanceof a?e:new a((function(t){t(e)}))}return new(a||(a=Promise))((function(a,r){function s(e){try{c(n.next(e))}catch(e){r(e)}}function o(e){try{c(n["throw"](e))}catch(e){r(e)}}function c(e){e.done?a(e.value):i(e.value).then(s,o)}c((n=n.apply(e,t||[])).next())}))};var __generator=this&&this.__generator||function(e,t){var a={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},n,i,r,s;return s={next:o(0),throw:o(1),return:o(2)},typeof Symbol==="function"&&(s[Symbol.iterator]=function(){return this}),s;function o(e){return function(t){return c([e,t])}}function c(o){if(n)throw new TypeError("Generator is already executing.");while(s&&(s=0,o[0]&&(a=0)),a)try{if(n=1,i&&(r=o[0]&2?i["return"]:o[0]?i["throw"]||((r=i["return"])&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;if(i=0,r)o=[o[0]&2,r.value];switch(o[0]){case 0:case 1:r=o;break;case 4:a.label++;return{value:o[1],done:false};case 5:a.label++;i=o[1];o=[0];continue;case 7:o=a.ops.pop();a.trys.pop();continue;default:if(!(r=a.trys,r=r.length>0&&r[r.length-1])&&(o[0]===6||o[0]===2)){a=0;continue}if(o[0]===3&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(o[0]===6&&a.label<r[1]){a.label=r[1];r=o;break}if(r&&a.label<r[2]){a.label=r[2];a.ops.push(o);break}if(r[2])a.ops.pop();a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e];i=0}finally{n=r=0}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:true}}};import{r as registerInstance,h,g as getElement,H as Host,c as createEvent}from"./index-980f930f.js";var areaCss="taro-movable-area-core{display:block;position:relative;width:10px;height:10px}";var MovableArea=function(){function e(e){var t=this;registerInstance(this,e);this.views=[];this.scaleLength=0;this.viewsChanged=function(){t.views=[];var e=t.element.querySelectorAll("taro-movable-view-core");Array.from(e).forEach((function(e){t.views.push(e)}));t.updateArea()};this.handleTouchStart=function(e){var a=e.touches;if(!a||a.length<=1){return}var n={width:a[1].pageX-a[0].pageX,height:a[1].pageY-a[0].pageY};t.scaleLength=Math.sqrt(n.width*n.width+n.height*n.height);if(t.scaleArea){return}var i=function(e,t){var a=function(e,t){if(!(e=e.parentNode)){return false}return(!(e instanceof HTMLElement)||e!==document.body)&&(e===t||e===t.element||e.element===t||a(e,t))};for(var n=0;n<t.length;n++){var i=t[n];if(e===i["element"]||a(e,i)){return i}}};var r=i(a[0].target,t.views);var s=i(a[1].target,t.views);t.scaleTarget=r&&r===s?r:undefined};this.handleTouchMove=function(e){var a=e.touches;if(!a||a.length<=1){return}e.preventDefault();var n={width:a[1].pageX-a[0].pageX,height:a[1].pageY-a[0].pageY};if(t.scaleLength>0){t.updateScale(Math.sqrt(n.width*n.width+n.height*n.height)/t.scaleLength)}};this.handleTouchEnd=function(e){var a,n;if(e.touches&&e.touches.length||!e.changedTouches){return}t.scaleLength=0;if(t.scaleArea){t.views.forEach((function(e){var t;(t=e["endScale"])===null||t===void 0?void 0:t.call(e)}))}else{(n=(a=t.scaleTarget)===null||a===void 0?void 0:a["endScale"])===null||n===void 0?void 0:n.call(a)}t.scaleTarget=undefined};this.updateScale=function(e){var a,n;if(!e||e===1){return}if(t.scaleArea){t.views.forEach((function(t){var a;(a=t["setScale"])===null||a===void 0?void 0:a.call(t,e)}))}else{(n=(a=t.scaleTarget)===null||a===void 0?void 0:a["setScale"])===null||n===void 0?void 0:n.call(a,e)}};this.updateArea=function(){var e=window.getComputedStyle(t.element);var a=t.element.getBoundingClientRect();var n=["Left","Right"].map((function(t){return parseFloat(e["border"+t+"Width"])+parseFloat(e["padding"+t])}));var i=["Top","Bottom"].map((function(t){return parseFloat(e["border"+t+"Width"])+parseFloat(e["padding"+t])}));t.views.forEach((function(e){var r;(r=e["setParent"])===null||r===void 0?void 0:r.call(e,{element:t.element,area:{height:a.height-i[0]-i[1],width:a.width-n[0]-n[1]}})}))};this.scaleArea=undefined}e.prototype.connectedCallback=function(){var e=this;this.observer=new MutationObserver((function(t){t.forEach((function(t){var a,n;if(t.attributeName==="class"||t.attributeName==="style"){var i=e.element.offsetWidth;var r=e.element.offsetHeight;if(i!==((a=e.offset)===null||a===void 0?void 0:a.width)||r!==((n=e.offset)===null||n===void 0?void 0:n.height)){e.updateArea()}e.offset={width:i,height:r}}}))}));this.observer.observe(this.element,{attributes:true})};e.prototype.disconnectedCallback=function(){var e;(e=this.observer)===null||e===void 0?void 0:e.disconnect()};e.prototype.componentDidLoad=function(){this.viewsChanged()};e.prototype.render=function(){return h(Host,{onTouchStart:this.handleTouchStart,onTouchMove:this.handleTouchMove,onTouchEnd:this.handleTouchEnd})};Object.defineProperty(e.prototype,"element",{get:function(){return getElement(this)},enumerable:false,configurable:true});return e}();MovableArea.style=areaCss;var viewCss="taro-movable-view-core{display:inline-block;position:absolute;left:0;top:0;width:10px;height:10px}";var MovableView=function(){function e(e){var t=this;registerInstance(this,e);this.onChange=createEvent(this,"change",7);this.onScale=createEvent(this,"scale",7);this.onHTouchMove=createEvent(this,"htouchmove",7);this.onVTouchMove=createEvent(this,"vtouchmove",7);this.translateX=0;this.translateY=0;this.origin={x:0,y:0};this.area={width:0,height:0};this.originScale=1;this.currentScale=1;this.width=0;this.height=0;this.minX=0;this.minY=0;this.maxX=0;this.maxY=0;this.baseX=0;this.baseY=0;this.offset={x:0,y:0};this.scaleOffset={x:0,y:0};this.getLimitXY=function(e,a){var n=false;e>t.maxX?(e=t.maxX,n=true):e<t.minX&&(e=t.minX,n=true);a>t.maxY?(a=t.maxY,n=true):a<t.minY&&(a=t.minY,n=true);return{x:e,y:a,outOfBounds:n}};this.animationTo=function(e,a,n,i,r,s,o){if(t.animation){t.setTransform(e,a,n,i,r,s);o===null||o===void 0?void 0:o()}else{t.setTransform(e,a,n,i,r,s)}};this.setTransform=function(e,a,n,i,r,s){e=Number(e.toFixed(1));a=Number(a.toFixed(1));n=Number((n!==null&&n!==void 0?n:t.currentScale).toFixed(3));if(!t.outOfBounds){var o=t.getLimitXY(e,a);e=o.x;a=o.y}var c=function(e,t){return+((1e3*e-1e3*t)/1e3).toFixed(1)};var l=c(e,t.scaleOffset.x);var h=c(a,t.scaleOffset.y);if(t.translateX!==e||t.translateY!==a){!r&&t.onChange.emit({x:l,y:h,source:i})}if(n!==t.currentScale){s&&t.onScale.emit({scale:n,x:l,y:h})}var u="translateX(".concat(e,"px) translateY(").concat(a,"px) translateZ(0px) scale(").concat(n,")");t.element.style.transform=u;t.element.style.webkitTransform=u;t.translateX=e;t.translateY=a;t.currentScale=n};this.updateOffset=function(){var e=function(t,a){if(t===a||!t.offsetParent){return{left:0,top:0}}var n=e(t.offsetParent,a);return{left:t.offsetLeft+n.left,top:t.offsetTop+n.top}};if(!t.parent){return}var a=e(t.element,t.parent);t.offset.x=a.left;t.offset.y=a.top};this.updateScaleOffset=function(e){if(e===void 0){e=t.currentScale}var a=t.element.getBoundingClientRect();t.height=a.height/t.currentScale;t.width=a.width/t.currentScale;t.scaleOffset.x=(t.width*e-t.width)/2;t.scaleOffset.y=(t.height*e-t.height)/2};this.updateBoundary=function(){var e=0-t.offset.x+t.scaleOffset.x;var a=t.area.width-t.width-t.offset.x-t.scaleOffset.x;t.minX=Math.min(e,a);t.maxX=Math.max(e,a);var n=0-t.offset.y+t.scaleOffset.y;var i=t.area.height-t.height-t.offset.y-t.scaleOffset.y;t.minY=Math.min(n,i);t.maxY=Math.max(n,i)};this.updateScale=function(e,a,n){if(!t.scale){return}var i=t.adjustScale(e);t.updateScaleOffset(i);t.updateBoundary();var r=t.getLimitXY(t.translateX,t.translateY),s=r.x,o=r.y;if(a){t.animationTo(s,o,i,"",true,true,n)}else if(!t.updating){t.updating=true;requestAnimationFrame((function(){t.setTransform(s,o,i,"",true,true);t.updating=false}))}};this.setOriginScale=function(e){t.originScale=e};this.adjustScale=function(e){return Math.min(10,t.scaleMax,Math.max(.5,t.scaleMin,e))};this.handleTouchStart=function(e){var a=e.touches;if(t.disabled||a.length>1||!t.element){return}var n=a[0];t.touching=true;t.firstMoveFireEvent=false;t.origin.x=n.screenX;t.origin.y=n.screenY;t.baseX=t.translateX;t.baseY=t.translateY;t.element.style.willChange="transform"};this.handleTouchMove=function(e){var a=e.touches;if(t.disabled||!t.element||t.scaling||!t.touching||a.length>1){return}e.preventDefault();var n=a[0];var i=n.screenX-t.origin.x;var r=n.screenY-t.origin.y;t.setTransform(t.xMove?i+t.baseX:0,t.yMove?r+t.baseY:0);if(!t.firstMoveFireEvent){t.firstMoveFireEvent=true;var s=Math.abs(i)>Math.abs(r)?t.onHTouchMove:t.onVTouchMove;s.emit({originalEvent:e,bubbles:false,capturePhase:false,composed:true,extraFields:{touches:e.touches||{},changedTouches:e.changedTouches||{}}})}};this.handleTouchEnd=function(e){var a=e.changedTouches[0];if(t.disabled||!t.touching||!a){return}t.touching=false;var n=a.screenX-t.origin.x;var i=a.screenY-t.origin.y;t.setTransform(t.xMove?n+t.baseX:0,t.yMove?i+t.baseY:0)};this.x=0;this.y=0;this.direction="none";this.outOfBounds=false;this.inertia=false;this.friction=2;this.damping=20;this.disabled=false;this.scale=false;this.scaleMin=.5;this.scaleMax=10;this.scaleValue=1;this.animation=true}e.prototype.watchX=function(e){this.setTransform(parseFloat("".concat(e||0)),this.translateY)};e.prototype.watchY=function(e){this.setTransform(this.translateX,parseFloat("".concat(e||0)))};e.prototype.watchScaleMinOrMax=function(){if(!this.scale)return false;this.updateScale(this.currentScale,true);this.setOriginScale(this.currentScale)};e.prototype.watchScaleValue=function(e){if(!this.scale){return false}this.updateScale(e,true);this.setOriginScale(e);return e};e.prototype.setParent=function(e){var t=e.element,a=e.area;return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(n){e=this.scale?this.scaleValue:1;this.area=a;this.parent=t;this.updateOffset();this.updateScaleOffset(e);this.updateBoundary();this.setTransform(Number(this.x)+this.scaleOffset.x,Number(this.y)+this.scaleOffset.y,e,"",true);this.setOriginScale(e);return[2]}))}))};e.prototype.endScale=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){this.scaling=false;this.setOriginScale(this.currentScale);return[2]}))}))};e.prototype.setScale=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){if(!this.scale){return[2]}this.scaling=true;this.updateScale(e*this.originScale);return[2]}))}))};e.prototype.connectedCallback=function(){var e=this;this.observer=new MutationObserver((function(t){t.forEach((function(t){var a=t.attributeName;if(a&&["class","style"].includes(a)){var n=t.oldValue;var i=t.target.getAttribute(a);if(n===i){return}var r=function(e){return e===null||e===void 0?void 0:e.split(";").filter((function(e){return!["transform","will-change"].find((function(t){return e.trim().startsWith(t)}))})).join(";")};if(a==="style"&&r(i)===r(n)){return}e.updateOffset();e.updateScaleOffset();e.updateBoundary();e.setTransform(e.translateX,e.translateY)}}))}));this.observer.observe(this.element,{attributes:true,attributeOldValue:true})};e.prototype.disconnectedCallback=function(){var e;(e=this.observer)===null||e===void 0?void 0:e.disconnect()};e.prototype.componentDidLoad=function(){this.element.style.transformOrigin="center";this.xMove=["horizontal","all"].includes(this.direction);this.yMove=["vertical","all"].includes(this.direction);if(this.friction<=0){this.friction=2}if(this.x||this.y){var e=parseFloat("".concat(this.x||0));var t=parseFloat("".concat(this.y||0));this.setTransform(e,t)}};e.prototype.render=function(){return h(Host,{onTouchStart:this.handleTouchStart,onTouchMove:this.handleTouchMove,onTouchEnd:this.handleTouchEnd})};Object.defineProperty(e.prototype,"element",{get:function(){return getElement(this)},enumerable:false,configurable:true});Object.defineProperty(e,"watchers",{get:function(){return{x:["watchX"],y:["watchY"],scaleMin:["watchScaleMinOrMax"],scaleMax:["watchScaleMinOrMax"],scaleValue:["watchScaleValue"]}},enumerable:false,configurable:true});return e}();MovableView.style=viewCss;export{MovableArea as taro_movable_area_core,MovableView as taro_movable_view_core};